<!-- Overlay De Carregamento -->
<app-loading-overlay *ngIf="isLoading"></app-loading-overlay>

<!-- Scroll Top-->
<p-scrollTop />

<!-- Modal Das fotos De Agua e Gas -->
<app-photos-modal #appPhotoModal></app-photos-modal>

<!-- Modal informando que há leituras falhadas-->
<app-failed-reading-modal #failedReadingdsModal></app-failed-reading-modal>

<!-- Modal informando que há leituras pendentes-->
<app-pending-readings-modal
  #pendingReadingsModal
  (modalResponse)="handleModalResponse($event)">
</app-pending-readings-modal>

<!-- Página Principal -->
<app-page-default
  [pageTitle]="condominiumTitle"
  [pageSubtitle]="'Código: ' + condominiumId"
  [pageObservation]="'Observação: ' + condominiumObservation"
  [breadcrumbItems]="breadcrumbItems">

  <!-- Botão que abre o modal de leituras com falha -->
  <div class="flex justify-content-center mb-3">
    <button
      pButton
      label="Leituras pendentes"
      icon="pi pi-exclamation-triangle"
      class="p-button-danger"
      [disabled]="failedReadingsCount == 0"
      (click)="openFailedReadingsModal()">
    </button>
  </div>

  <!-- Resumo de Leituras Centralizado -->
  <div class="mb-3 text-center">
    <div
      class="inline-flex flex-wrap justify-content-center gap-4 font-medium text-900">
      <div class="flex align-items-center gap-2">
        <i class="pi pi-check-circle text-green-500"></i>
        <span>{{ successfulReadingsCount }} com sucesso</span>
      </div>
      <div class="flex align-items-center gap-2">
        <i class="pi pi-times-circle text-red-500"></i>
        <span>{{ failedReadingsCount }} com erro</span>
      </div>
      <div class="flex align-items-center gap-2">
        <i class="pi pi-clock text-orange-500"></i>
        <span>{{ pendingReadingsCount }} pendente(s)</span>
      </div>
    </div>
  </div>

  <!-- Filtro De Busca -->
  <p-iconField class="w-full" iconPosition="left">
    <p-inputIcon styleClass="pi pi-search" />
    <input
      class="w-full"
      type="text"
      pInputText
      placeholder="Buscar"
      [(ngModel)]="searchFilter" />
  </p-iconField>

  <!-- Lista Principal -->
  <p-dataView [value]="filteredApartments">
    <ng-template pTemplate="list" let-values>
      <div class="col-12" *ngFor="let item of values; let first = first">
        <div
          class="flex flex-column align-items-center p-4 gap-3"
          [ngClass]="{ 'border-top-1 surface-border': !first }">
          <!-- Número do Apartamento -->
          <h2 class="text-center text-900 font-medium w-full mb-4">
            Unidade Nº {{ item['economia'] }}
          </h2>

          <!-- Leitura de água, água quente e gás -->
          <div
            class="reading-container w-full"
            [ngClass]="{
              'layout-three': hasThreeBlocks(item),
              'layout-two': hasTwoBlocks(item),
              'layout-single': hasOneBlock(item)
            }">
        

            <!-- Água Fria -->
            <app-reading-block
              *ngIf="item['leitura_atual_agua'] !== 'nao_possui'"
              [type]="'agua'"
              [previousReading]="item['leitura_anterior_agua']"
              [currentReading]="item['leitura_atual_agua']"
              (readingChanged)="readingChanged(item, $event)">
            </app-reading-block>

            <!-- Gás -->
            <app-reading-block
              *ngIf="item['leitura_atual_gas'] !== 'nao_possui'"
              [type]="'gas'"
              [previousReading]="item['leitura_anterior_gas']"
              [currentReading]="item['leitura_atual_gas']"
              (readingChanged)="readingChanged(item, $event)">
            </app-reading-block>

            <!-- Água Quente -->
            <app-reading-block
              *ngIf="item['leitura_anterior_aguaq'] !== 'nao_possui'"
              [type]="'aguaq'"
              [previousReading]="item['leitura_anterior_aguaq']"
              [currentReading]="item['leitura_atual_aguaq']"
              (readingChanged)="readingChanged(item, $event)">
            </app-reading-block>

          </div>

          <!-- Botão de Fotos -->
          <p-button
            *ngIf="item['imagem'] == 'sim'"
            label="Fotos"
            icon="pi pi-camera"
            (onClick)="openPhotoModalComponent(item)"
            [badge]="(item['imagem_atual_agua'] == null && item['leitura_atual_agua'] != 'nao_possui') || (item['imagem_atual_gas'] == null && item['leitura_atual_gas'] != 'nao_possui') ? 'Pend.' : ''"
            badgeClass="p-badge-danger">
          </p-button>
        </div>
      </div>
    </ng-template>
  </p-dataView>
</app-page-default>
